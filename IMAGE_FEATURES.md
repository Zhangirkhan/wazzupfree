# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –≤ —á–∞—Ç–µ

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ. –°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

1. **–ü—Ä–∏–Ω–∏–º–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤** —á–µ—Ä–µ–∑ Wazzup24
2. **–ó–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏** –≤ —á–∞—Ç
3. **–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —á–∞—Ç–∞
4. **–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–µ—Ä–≤–∏—Å—ã

- **ImageService** (`app/Services/ImageService.php`) - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- **MessengerService** - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **WebhookController** - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ Wazzup24

### –ú–æ–¥–µ–ª–∏

- **Message** - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–∏–ø `image` –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Chat** - –¥–ª—è —Å–≤—è–∑–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### 1. –ü—Ä–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤

–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WhatsApp:

1. Wazzup24 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
2. `WebhookController` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ `imageMessage`
3. `MessengerService::handleIncomingImage()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
4. `ImageService::saveImageFromUrl()` —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
5. –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ `image` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

### 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏

–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:

1. –ù–∞–∂–∏–º–∞—é—Ç –∫–Ω–æ–ø–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
2. –í—ã–±–∏—Ä–∞—é—Ç —Ñ–∞–π–ª (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPEG, PNG, JPG, GIF, WebP)
3. –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/user/chat/upload-image`
4. `ImageService::saveImageFromFile()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
5. –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ `image`

### 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —á–∞—Ç–µ:

- **–í —á–∞—Ç–µ**: —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (–º–∞–∫—Å–∏–º—É–º 300px –≤—ã—Å–æ—Ç–∞)
- **–ü–æ–ª–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä**: –∫–ª–∏–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
- **–ü–æ–¥–ø–∏—Å–∏**: –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å

### 4. –•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

- **–ü—É—Ç—å**: `storage/app/public/chat-images/YYYY/MM/DD/`
- **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ**: `chat_{chat_id}_{timestamp}_{random}.{extension}`
- **–î–æ—Å—Ç—É–ø**: —á–µ—Ä–µ–∑ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É `public/storage`

## API Endpoints

### –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```
POST /user/chat/upload-image
Content-Type: multipart/form-data

Parameters:
- image: —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º 10MB)
- chat_id: ID —á–∞—Ç–∞
- _token: CSRF —Ç–æ–∫–µ–Ω

Response:
{
    "success": true,
    "message": "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ",
    "message_id": 123,
    "image_data": {
        "url": "/storage/chat-images/2024/01/15/chat_1_1705123456_abc123.jpg",
        "path": "chat-images/2024/01/15/chat_1_1705123456_abc123.jpg",
        "filename": "chat_1_1705123456_abc123.jpg",
        "size": 1024000,
        "extension": "jpg",
        "original_name": "photo.jpg"
    }
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
```
GET /user/chat/messages/{chatId}?last_id={lastMessageId}

Response:
{
    "success": true,
    "messages": [
        {
            "id": 123,
            "content": "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
            "created_at": "2024-01-15T10:30:00Z",
            "is_from_client": true,
            "sender_name": "–ö–ª–∏–µ–Ω—Ç",
            "sender_avatar": "–ö",
            "type": "image",
            "user_id": 1,
            "image_data": {
                "url": "/storage/chat-images/2024/01/15/chat_1_1705123456_abc123.jpg",
                "path": "chat-images/2024/01/15/chat_1_1705123456_abc123.jpg",
                "filename": "chat_1_1705123456_abc123.jpg",
                "size": 1024000,
                "extension": "jpg",
                "caption": "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
            }
        }
    ],
    "last_message_id": 123,
    "unread_count": 0
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ messages

```sql
-- –ü–æ–ª–µ type –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ 'image'
type ENUM('text', 'system', 'file', 'image') DEFAULT 'text'

-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ JSON –ø–æ–ª–µ metadata
metadata JSON
```

### –ü—Ä–∏–º–µ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

```json
{
    "image_url": "/storage/chat-images/2024/01/15/chat_1_1705123456_abc123.jpg",
    "image_path": "chat-images/2024/01/15/chat_1_1705123456_abc123.jpg",
    "image_filename": "chat_1_1705123456_abc123.jpg",
    "image_size": 1024000,
    "image_extension": "jpg",
    "original_url": "https://wazzup24.com/images/abc123.jpg",
    "caption": "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    "client_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
    "direction": "incoming"
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤

- **–¢–∏–ø—ã**: —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPEG, PNG, JPG, GIF, WebP)
- **–†–∞–∑–º–µ—Ä**: –º–∞–∫—Å–∏–º—É–º 10MB
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ MIME-—Ç–∏–ø–∞**: –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –∫–ª–∏–µ–Ω—Ç–µ

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

- **–ó–∞–≥—Ä—É–∑–∫–∞**: —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —á–∞—Ç—É
- **–ü—Ä–æ—Å–º–æ—Ç—Ä**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —á–∞—Ç—É
- **–£–¥–∞–ª–µ–Ω–∏–µ**: —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∞–¥–º–∏–Ω—ã

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏

```bash
php artisan storage:link
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```bash
mkdir -p storage/app/public/chat-images
```

### 3. –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

```bash
chmod -R 755 storage/app/public/chat-images
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

1. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (üì∑) –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
4. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≤ —á–∞—Ç–µ

### –î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WhatsApp
2. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –≤ —á–∞—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
3. –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é, –æ–Ω–∞ —Ç–∞–∫–∂–µ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

- **–í —á–∞—Ç–µ**: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–º –≤–∏–¥–µ
- **–ü–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä**: –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
- **–ó–∞–∫—Ä—ã—Ç–∏–µ**: –∫–ª–∏–∫–Ω–∏—Ç–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```php
Log::info('Image saved successfully', [
    'filename' => $filename,
    'path' => $path,
    'url' => $publicUrl,
    'size' => strlen($imageContent)
]);
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- **–û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏**: –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **–û—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è**: –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∞–π–ª
- **–ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Laravel
- **CDN**: –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
