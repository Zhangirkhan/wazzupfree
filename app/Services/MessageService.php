<?php

namespace App\Services;

use App\Contracts\MessageServiceInterface;
use App\Events\MessageSent;
use App\Exceptions\ChatNotFoundException;
use App\Exceptions\FileUploadException;
use App\Models\Chat;
use App\Models\Message;
use App\Models\User;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Redis;

class MessageService implements MessageServiceInterface
{
    public function sendMessage(string $chatId, string $message, User $user, string $type = 'text', ?UploadedFile $file = null): Message
    {
        Log::info('üîπ –ë–≠–ö: MessageService::sendMessage –≤—ã–∑–≤–∞–Ω', [
            'chat_id' => $chatId,
            'user_id' => $user->id,
            'message' => $message,
            'type' => $type,
            'has_file' => $file !== null,
            'file_info' => $file ? [
                'name' => $file->getClientOriginalName(),
                'size' => $file->getSize(),
                'mime' => $file->getMimeType()
            ] : null
        ]);

        $chat = $this->validateChatAccess($chatId, $user);
        Log::info('üîπ –ë–≠–ö: –î–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É –ø—Ä–æ–≤–µ—Ä–µ–Ω', ['chat_id' => $chat->id]);

        $messageData = [
            'chat_id' => $chat->id,
            'user_id' => $user->id,
            'content' => $message ?: ($file ? $file->getClientOriginalName() : ''),
            'type' => $type,
            'direction' => 'out'
        ];

        Log::info('üîπ –ë–≠–ö: –î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã', $messageData);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
        if ($file) {
            Log::info('üîπ –ë–≠–ö: –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞');
            try {
                $filename = time() . '_' . $file->getClientOriginalName();
                $path = $file->storeAs('chat_files', $filename, 'public');

                Log::info('üîπ –ë–≠–ö: –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω', [
                    'filename' => $filename,
                    'path' => $path,
                    'full_url' => config('app.url') . '/storage/' . $path
                ]);

                $messageData['metadata'] = [
                    'file_path' => config('app.url') . '/storage/' . $path,
                    'file_name' => $file->getClientOriginalName(),
                    'file_size' => $file->getSize(),
                    'mime_type' => $file->getMimeType()
                ];

                Log::info('üîπ –ë–≠–ö: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã', $messageData['metadata']);
            } catch (\Exception $e) {
                Log::error('üî∏ –ë–≠–ö: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', [
                    'error' => $e->getMessage(),
                    'file_name' => $file->getClientOriginalName()
                ]);
                throw new FileUploadException('Failed to upload file: ' . $e->getMessage());
            }
        }

        Log::info('üîπ –ë–≠–ö: –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î', $messageData);
        $message = Message::create($messageData);
        Log::info('üîπ –ë–≠–ö: –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ', [
            'message_id' => $message->id,
            'created_at' => $message->created_at
        ]);

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
        $chat->update(['updated_at' => now()]);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Redis Pub/Sub
        Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Redis Pub/Sub');
        $this->publishToRedis($chatId, $message->load('user'));

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–∞—Ç–∞
        Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        $this->sendGlobalNotifications($chatId, $message->load('user'));

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Wazzup24 (–¥–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —á–∞—Ç–æ–≤)
        if ($chat->is_messenger_chat && $chat->messenger_phone) {
            Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Wazzup24', [
                'chat_id' => $chatId,
                'messenger_phone' => $chat->messenger_phone,
                'organization_id' => $chat->organization_id
            ]);
            $this->sendMessageViaWazzup24($chat, $message, $user);
        }

        Log::info('üîπ –ë–≠–ö: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ', [
            'message_id' => $message->id,
            'chat_id' => $chatId,
            'user_id' => $user->id,
            'type' => $type,
            'has_file' => $file !== null,
            'content' => $message->content,
            'metadata' => $message->metadata
        ]);

        return $message->load('user');
    }

    public function getChatMessages(string $chatId, User $user, int $perPage = 50): LengthAwarePaginator
    {
        $this->validateChatAccess($chatId, $user);

        return Message::where('chat_id', $chatId)
            ->with('user')
            ->orderBy('created_at', 'desc') // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
            ->paginate($perPage);
    }

    public function sendSystemMessage(string $chatId, string $message, User $user): Message
    {
        $chat = $this->validateChatAccess($chatId, $user);

        return Message::create([
            'chat_id' => $chat->id,
            'user_id' => $user->id,
            'content' => $message,
            'type' => 'system',
            'direction' => 'out'
        ]);
    }

    private function validateChatAccess(string $chatId, User $user): Chat
    {
        // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ª—é–±–æ–º—É —á–∞—Ç—É
        if ($user->role === 'admin') {
            $chat = Chat::where('id', $chatId)->first();
        } else {
            // –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º —á–∞—Ç–∞–º
            $chat = Chat::where('id', $chatId)
                ->where(function($query) use ($user) {
                    $query->where('created_by', $user->id)
                          ->orWhere('assigned_to', $user->id);
                })
                ->first();
        }

        if (!$chat) {
            Log::warning('Chat access denied', ['chat_id' => $chatId, 'user_id' => $user->id]);
            throw new ChatNotFoundException();
        }

        return $chat;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Redis Pub/Sub
     */
    private function publishToRedis(string $chatId, Message $message): void
    {
        try {
            $data = [
                'type' => 'new_message',
                'chatId' => $chatId,
                'message' => [
                    'id' => $message->id,
                    'message' => $message->content, // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
                    'content' => $message->content,
                    'type' => $message->type,
                    'is_from_client' => $message->direction === 'in',
                    'is_read' => false, // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–æ
                    'read_at' => null,
                    'file_path' => $message->metadata['file_path'] ?? null,
                    'file_name' => $message->metadata['file_name'] ?? null,
                    'file_size' => $message->metadata['file_size'] ?? null,
                    'created_at' => $message->created_at->toISOString(),
                    'user' => [
                        'id' => $message->user->id,
                        'name' => $message->user->name,
                        'email' => $message->user->email,
                        'role' => $message->user->role,
                    ],
                ],
                'timestamp' => now()->toISOString()
            ];

            // –ü—É–±–ª–∏–∫—É–µ–º –≤ Redis –∫–∞–Ω–∞–ª —á–∞—Ç–∞
            Redis::publish('chat.' . $chatId, json_encode($data));

            Log::info('Message published to Redis', [
                'chat_id' => $chatId,
                'message_id' => $message->id,
                'channel' => 'chat.' . $chatId
            ]);
        } catch (\Exception $e) {
            Log::error('Failed to publish message to Redis', [
                'error' => $e->getMessage(),
                'chat_id' => $chatId,
                'message_id' => $message->id
            ]);
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
     */
    private function sendGlobalNotifications(string $chatId, Message $message): void
    {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ (–∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
            $chat = Chat::find($chatId);
            if (!$chat) {
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            $recipients = [];

            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
            if ($chat->assigned_user_id && $chat->assigned_user_id !== $message->user_id) {
                $recipients[] = $chat->assigned_user_id;
            }

            if ($chat->user_id &&
                $chat->user_id !== $message->user_id &&
                $chat->user_id !== $chat->assigned_user_id) {
                $recipients[] = $chat->user_id;
            }

            // –î–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            // (–∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è), –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–∞—Ç–µ
            $allUsers = \App\Models\User::where('id', '!=', $message->user_id)
                ->where('is_active', true)
                ->pluck('id')
                ->toArray();

            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö
            $recipients = array_unique(array_merge($recipients, $allUsers));

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é
            foreach (array_unique($recipients) as $userId) {
                $notificationData = [
                    'type' => 'unread_message',
                    'chat_id' => $chatId,
                    'chat_name' => $chat->client_name,
                    'message' => [
                        'id' => $message->id,
                        'content' => $message->content,
                        'created_at' => $message->created_at->toISOString(),
                        'user' => [
                            'id' => $message->user->id,
                            'name' => $message->user->name,
                        ]
                    ],
                    'unread_count' => $this->getUnreadCount($chatId, $userId),
                    'timestamp' => now()->toISOString()
                ];

                // –ü—É–±–ª–∏–∫—É–µ–º –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                Redis::publish('user.' . $userId . '.notifications', json_encode($notificationData));
            }

            Log::info('Global notifications sent', [
                'chat_id' => $chatId,
                'message_id' => $message->id,
                'recipients' => $recipients
            ]);
        } catch (\Exception $e) {
            Log::error('Failed to send global notifications', [
                'error' => $e->getMessage(),
                'chat_id' => $chatId,
                'message_id' => $message->id
            ]);
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    private function getUnreadCount(string $chatId, int $userId): int
    {
        try {
            return Message::where('chat_id', $chatId)
                ->where('user_id', '!=', $userId)
                ->where('is_read', false)
                ->count();
        } catch (\Exception $e) {
            Log::error('Failed to get unread count', [
                'error' => $e->getMessage(),
                'chat_id' => $chatId,
                'user_id' => $userId
            ]);
            return 0;
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Wazzup24
     */
    private function sendMessageViaWazzup24(Chat $chat, Message $message, User $user): void
    {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏ Wazzup24 –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            if (!class_exists('\App\Services\Wazzup24Service') || !$chat->organization) {
                Log::warning('Wazzup24Service –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', [
                    'chat_id' => $chat->id,
                    'organization_id' => $chat->organization_id
                ]);
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            if (!$chat->organization->isWazzup24Configured()) {
                Log::warning('Wazzup24 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', [
                    'chat_id' => $chat->id,
                    'organization_id' => $chat->organization_id,
                    'organization_name' => $chat->organization->name
                ]);
                return;
            }

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            $wazzupService = \App\Services\Wazzup24Service::forOrganization($chat->organization);

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            $channelId = $wazzupService->getChannelId();
            $chatType = 'whatsapp';
            $chatId = $chat->messenger_phone;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –º–µ—Ç–æ–¥–æ–º
            if ($message->type === 'image' && isset($message->metadata['file_path'])) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                $imageUrl = $message->metadata['file_path'];

                Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Wazzup24 API', [
                    'channel_id' => $channelId,
                    'chat_type' => $chatType,
                    'chat_id' => $chatId,
                    'image_url' => $imageUrl,
                    'user_name' => $user->name
                ]);

                $result = $wazzupService->sendImage(
                    $channelId,
                    $chatType,
                    $chatId,
                    $imageUrl,
                    null, // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    $user->id,
                    $message->id
                );

                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å —É—Å–ø–µ—à–Ω–æ –∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                if ($result['success'] && !empty($message->content)) {
                    $caption = "*{$user->name}*\n\n{$message->content}";
                    
                    Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é', [
                        'caption' => $caption
                    ]);
                    
                    $captionResult = $wazzupService->sendMessage(
                        $channelId,
                        $chatType,
                        $chatId,
                        $caption,
                        $user->id,
                        $message->id
                    );
                    
                    if (!$captionResult['success']) {
                        Log::warning('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é', [
                            'error' => $captionResult['error']
                        ]);
                    }
                }
            } elseif ($message->type === 'video' && isset($message->metadata['file_path'])) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
                $videoUrl = $message->metadata['file_path'];

                Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Wazzup24 API', [
                    'channel_id' => $channelId,
                    'chat_type' => $chatType,
                    'chat_id' => $chatId,
                    'video_url' => $videoUrl,
                    'user_name' => $user->name
                ]);

                $result = $wazzupService->sendVideo(
                    $channelId,
                    $chatType,
                    $chatId,
                    $videoUrl,
                    null, // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å —Å –≤–∏–¥–µ–æ
                    $user->id,
                    $message->id
                );

                // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å —É—Å–ø–µ—à–Ω–æ –∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                if ($result['success'] && !empty($message->content)) {
                    $caption = "*{$user->name}*\n\n{$message->content}";
                    
                    Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –∫ –≤–∏–¥–µ–æ', [
                        'caption' => $caption
                    ]);
                    
                    $captionResult = $wazzupService->sendMessage(
                        $channelId,
                        $chatType,
                        $chatId,
                        $caption,
                        $user->id,
                        $message->id
                    );
                    
                    if (!$captionResult['success']) {
                        Log::warning('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –∫ –≤–∏–¥–µ–æ', [
                            'error' => $captionResult['error']
                        ]);
                    }
                }
            } else {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                $formattedMessage = "*{$user->name}*\n\n{$message->content}";

                Log::info('üîπ –ë–≠–ö: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Wazzup24 API', [
                    'channel_id' => $channelId,
                    'chat_type' => $chatType,
                    'chat_id' => $chatId,
                    'message_length' => strlen($formattedMessage),
                    'user_name' => $user->name
                ]);

                $result = $wazzupService->sendMessage(
                    $channelId,
                    $chatType,
                    $chatId,
                    $formattedMessage,
                    $user->id,
                    $message->id
                );
            }

            if ($result['success']) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å ID –æ—Ç Wazzup24
                $message->update([
                    'wazzup_message_id' => $result['message_id'] ?? null,
                    'metadata' => array_merge($message->metadata ?? [], [
                        'wazzup_sent' => true,
                        'wazzup_message_id' => $result['message_id'] ?? null,
                        'sent_via' => 'wazzup24'
                    ])
                ]);

                Log::info('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Wazzup24', [
                    'chat_id' => $chat->id,
                    'message_id' => $message->id,
                    'wazzup_id' => $result['message_id'] ?? null
                ]);
            } else {
                Log::error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Wazzup24', [
                    'chat_id' => $chat->id,
                    'message_id' => $message->id,
                    'error' => $result['error'] ?? 'Unknown error'
                ]);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
                $message->update([
                    'metadata' => array_merge($message->metadata ?? [], [
                        'wazzup_sent' => false,
                        'wazzup_error' => $result['error'] ?? 'Unknown error',
                        'sent_via' => 'failed'
                    ])
                ]);
            }

        } catch (\Exception $e) {
            Log::error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Wazzup24', [
                'chat_id' => $chat->id,
                'message_id' => $message->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏—Å–∫–ª—é—á–µ–Ω–∏–∏
            try {
                $message->update([
                    'metadata' => array_merge($message->metadata ?? [], [
                        'wazzup_sent' => false,
                        'wazzup_error' => $e->getMessage(),
                        'sent_via' => 'exception'
                    ])
                ]);
            } catch (\Exception $updateException) {
                Log::error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π Wazzup24', [
                    'message_id' => $message->id,
                    'update_error' => $updateException->getMessage()
                ]);
            }
        }
    }
}
