# Интеграция с Wazzup24

## Описание

Интеграция с Wazzup24 позволяет получать и отправлять сообщения WhatsApp через API. Когда клиент отправляет сообщение на ваш номер WhatsApp, оно автоматически появляется в системе как чат.

## Настройка

### 1. Переменные окружения

Добавьте в файл `.env`:

```env
# Wazzup24 Integration
WAZZUP24_API_KEY=your_api_key_here
WAZZUP24_WEBHOOK_URL=https://your-domain.com/api/webhook
WAZZUP24_CHANNEL_ID=your_channel_id  # Опционально, если у вас только один канал
```

### 2. Получение API ключа

1. Зарегистрируйтесь на [wazzup24.com](https://wazzup24.com)
2. Перейдите в личный кабинет
3. Получите API ключ в разделе "API"

### 3. Channel ID (опционально)

Channel ID нужен только если у вас несколько каналов WhatsApp. Если у вас только один канал, Wazzup24 автоматически использует его.

### 4. Настройка Webhook

1. В личном кабинете Wazzup24 перейдите в настройки webhook
2. Укажите URL: `https://your-domain.com/api/webhook`
3. Выберите события: `message`

## Тестирование без домена

### Использование ngrok

1. Установите ngrok: `npm install -g ngrok`
2. Запустите ngrok: `ngrok http 8000`
3. Скопируйте HTTPS URL (например: `https://abc123.ngrok.io`)
4. Укажите в Wazzup24 webhook URL: `https://abc123.ngrok.io/api/webhook`

### Локальное тестирование

1. Запустите сервер: `php artisan serve`
2. Используйте ngrok для создания публичного URL
3. Настройте webhook в Wazzup24

## Команды

### Проверка подключения

```bash
php artisan wazzup24:test-connection
```

## API Endpoints

### Webhook (входящие сообщения)
- **URL**: `POST /api/webhook`
- **Описание**: Получает сообщения от Wazzup24
- **Аутентификация**: Не требуется

### Отправка сообщений
- **URL**: `POST /api/chats/{chat}/wazzup24/send`
- **Описание**: Отправляет сообщение через Wazzup24
- **Аутентификация**: Требуется

### Проверка подключения
- **URL**: `GET /api/wazzup24/connection`
- **Описание**: Проверяет статус подключения к Wazzup24
- **Аутентификация**: Требуется

### Информация о чате
- **URL**: `GET /api/chats/{chat}/wazzup24/info`
- **Описание**: Получает информацию о чате в Wazzup24
- **Аутентификация**: Требуется

## Структура данных

### Чат (Chat)
- `phone` - номер телефона клиента
- `wazzup_chat_id` - ID чата в Wazzup24
- `type` - тип чата (должен быть 'wazzup')

### Сообщение (Message)
- `wazzup_message_id` - ID сообщения в Wazzup24
- `direction` - направление ('in' или 'out')
- `status` - статус сообщения

## Использование в интерфейсе

### Отображение чатов Wazzup24

Чаты с типом 'wazzup' автоматически отображаются в списке чатов с соответствующими иконками.

### Отправка сообщений

В интерфейсе чата Wazzup24 появляется форма для отправки сообщений с:
- Поле ввода сообщения
- Кнопка отправки
- Индикатор статуса подключения
- Уведомления об успешной отправке/ошибках

## Логирование

Все операции с Wazzup24 логируются в Laravel log:

```php
Log::info('Wazzup24 message sent successfully', [
    'chat_id' => $chat->id,
    'message_id' => $message->id
]);
```

## Обработка ошибок

Система обрабатывает следующие ошибки:
- Неверный API ключ
- Отсутствие подключения к интернету
- Ошибки Wazzup24 API
- Неверный формат данных

## Безопасность

- Webhook endpoint не требует аутентификации (стандарт Wazzup24)
- Все исходящие запросы требуют аутентификации
- API ключи хранятся в переменных окружения
- Все операции логируются

## Поддержка

При возникновении проблем:
1. Проверьте логи: `tail -f storage/logs/laravel.log`
2. Проверьте подключение: `php artisan wazzup24:test-connection`
3. Убедитесь, что webhook URL доступен из интернета
4. Проверьте настройки в личном кабинете Wazzup24
