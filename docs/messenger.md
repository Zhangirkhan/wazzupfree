# Мессенджер - Документация

## Обзор

Мессенджер - это система автоматической маршрутизации клиентских запросов по отделам компании через WhatsApp. Система работает как бот с меню выбора отдела и автоматической передачей чатов между сотрудниками и отделами.

## Функциональность

### Для клиентов

1. **Первое сообщение**: Клиент пишет на номер WhatsApp
2. **Выбор отдела**: Система показывает меню с отделами:
   ```
   Добро пожаловать! С кем хотите связаться?
   
   1. HR отдел
   2. IT отдел
   
   0. Выход
   ```
3. **Вопрос клиента**: После выбора отдела клиент пишет свой вопрос
4. **Автоматические уведомления**: При передаче между отделами клиент получает уведомления
5. **Завершение чата**: После завершения клиент может продолжить или вернуться в меню

### Для сотрудников

1. **Уведомления**: Сотрудники получают уведомления о новых сообщениях в их отделе
2. **Принятие чатов**: Сотрудники могут принимать чаты из своего отдела
3. **Передача внутри отдела**: Сотрудники могут передавать чаты другим сотрудникам отдела
4. **Передача между отделами**: Сотрудники могут передавать чаты в другие отделы
5. **Завершение чатов**: Сотрудники могут завершать чаты

## Статусы чатов

- `menu` - Клиент в главном меню
- `department_selected` - Клиент выбрал отдел, ожидает вопрос
- `active` - Активный чат с сотрудником
- `completed` - Завершенный чат

## Автоматические функции

1. **Автоматическое закрытие**: Чаты автоматически закрываются через 7 дней неактивности
2. **Уведомления клиентам**: При передаче между отделами клиент получает сообщение
3. **Форматирование сообщений**: Все сообщения клиентов отображаются с именем клиента

## Структура базы данных

### Новые поля в таблице `chats`:

- `department_id` - ID отдела
- `messenger_status` - Статус мессенджера
- `last_activity_at` - Время последней активности
- `is_messenger_chat` - Флаг мессенджер чата
- `messenger_phone` - Номер телефона клиента
- `messenger_data` - JSON данные состояния бота

## API Endpoints

### Мессенджер

- `GET /admin/messenger` - Список мессенджер чатов
- `GET /admin/messenger/{chat}` - Просмотр чата
- `POST /admin/messenger/{chat}/send` - Отправка сообщения
- `POST /admin/messenger/{chat}/accept` - Принятие чата
- `POST /admin/messenger/{chat}/transfer-user` - Передача сотруднику
- `POST /admin/messenger/{chat}/transfer-department` - Передача в отдел
- `POST /admin/messenger/{chat}/complete` - Завершение чата
- `POST /admin/messenger/bulk-accept` - Массовое принятие
- `POST /admin/messenger/close-inactive` - Закрытие неактивных чатов

## Команды

### Автоматическое закрытие чатов

```bash
# Закрыть неактивные чаты
php artisan messenger:close-inactive

# Тестовый запуск (без закрытия)
php artisan messenger:close-inactive --dry-run
```

## Планировщик задач

Система автоматически закрывает неактивные чаты каждый день в 2:00 утра.

## Настройка

### Конфигурация Wazzup24

Убедитесь, что в `.env` файле настроены:

```env
WAZZUP24_API_KEY=your_api_key
WAZZUP24_CHANNEL_ID=your_channel_id
WAZZUP24_WEBHOOK_URL=https://your-domain.com/api/webhook
```

### Создание отделов

Перед использованием мессенджера необходимо создать отделы в системе:

1. HR отдел (ID: 1)
2. IT отдел (ID: 2)
3. Другие отделы по необходимости

### Назначение сотрудников

Сотрудники должны быть назначены в соответствующие отделы через админ-панель.

## Использование

### Для администраторов

1. Перейдите в раздел "Мессенджер" в админ-панели
2. Просматривайте чаты по отделам
3. Принимайте и обрабатывайте чаты
4. Передавайте чаты между сотрудниками и отделами

### Для клиентов

1. Напишите сообщение на номер WhatsApp
2. Выберите нужный отдел из меню
3. Задайте свой вопрос
4. Получайте ответы от сотрудников

## Безопасность

- Доступ к чатам ограничен по отделам
- Сотрудники видят только чаты своих отделов
- Все действия логируются в системе
- История передач сохраняется для аудита

## Мониторинг

Система предоставляет статистику:
- Общее количество чатов
- Активные чаты
- Чаты в меню
- Завершенные чаты

## Поддержка

При возникновении проблем:
1. Проверьте логи в `storage/logs/laravel.log`
2. Убедитесь в правильности настроек Wazzup24
3. Проверьте статус webhook'ов
4. Обратитесь к администратору системы
